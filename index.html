<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>EV Stations Lviv +70km</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
body { margin:0; font-family: Arial; }
#map { height: 90vh; }
#info {
    padding:10px;
    background:#111;
    color:white;
}
button {
    padding:6px 10px;
    margin-left:10px;
}
</style>
</head>

<body>

<div id="info">
–°—Ç–∞–Ω—Ü—ñ—ó –≤—ñ–¥ 7 kW | –ó–Ω–∞–π–¥–µ–Ω–æ: <span id="count">0</span>
<button onclick="locateMe()">üìç –ú–æ—î –º—ñ—Å—Ü–µ</button>
</div>

<div id="map"></div>

<script>

// --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
const minPowerKW = 7;
const latitude = 49.8397;
const longitude = 24.0297;
const radiusKm = 70;

// --- –ö–ê–†–¢–ê ---
const map = L.map('map').setView([latitude, longitude], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

// --- –ö–õ–ê–°–¢–ï–† ---
const markers = L.markerClusterGroup();
map.addLayer(markers);

// --- –Ü–ö–û–ù–ö–ò ---
function getIcon(power){
    if(power >= 50){
        return L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1048/1048314.png',
            iconSize: [30,30]
        });
    } else {
        return L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3103/3103446.png',
            iconSize: [25,25]
        });
    }
}

// --- –ó–ê–ü–ò–¢ ---
const apiKey = "YOUR_API_KEY";

const url = `https://api.openchargemap.io/v3/poi/?output=json
&latitude=${latitude}
&longitude=${longitude}
&distance=${radiusKm}
&distanceunit=KM
&maxresults=1000
&key=${apiKey}`;

fetch(url)
.then(res => res.json())
.then(data => {

    let count = 0;

    data.forEach(station => {

        if(station.Connections){
            station.Connections.forEach(conn => {

                const power = conn.PowerKW || 0;

                if(power >= minPowerKW){

                    const marker = L.marker(
                        [station.AddressInfo.Latitude, station.AddressInfo.Longitude],
                        { icon: getIcon(power) }
                    );

                    marker.bindPopup(`
                        <b>${station.AddressInfo.Title}</b><br>
                        –ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å: ${power} kW<br>
                        –ê–¥—Ä–µ—Å–∞: ${station.AddressInfo.AddressLine1 || ''}
                    `);

                    markers.addLayer(marker);
                    count++;
                }
            });
        }
    });

    document.getElementById("count").innerText = count;
});

// --- –ê–í–¢–û–õ–û–ö–ê–¶–Ü–Ø ---
function locateMe(){
    map.locate({setView:true, maxZoom:13});
}

map.on('locationfound', function(e){
    L.marker(e.latlng).addTo(map)
    .bindPopup("–í–∏ —Ç—É—Ç")
    .openPopup();
});

// --- PWA ---
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js');
}

</script>

</body>
</html>
